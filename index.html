<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QTI IOL Player LIT</title>

    <base href="%VITE_BASE_HREF%" />
    <script src="//unpkg.com/navigo"></script>

    <!-- <script src="./index.js"></script> -->

    <script type="module" defer>
      // import '@citolab/qti-components/qti-components';
      // import '@citolab/qti-components/qti-test/core';
      // import '@citolab/qti-components/qti-test/components/test-navigation';
      // import '@citolab/qti-components/qti-test/components/test-container';
      // import '@citolab/qti-components/qti-test/components/test-next';
      // import '@citolab/qti-components/qti-test/components/test-prev';
      // import '@citolab/qti-components/qti-test/components/test-show-correct-response';
      // import '@citolab/qti-components/qti-test/components/test-end-attempt';
      // import '@citolab/qti-components/qti-test/components/test-paging-buttons-stamp';
      // import '@citolab/qti-components/qti-test/components/test-item-link';
      // import '@citolab/qti-components/qti-test/components/test-view';
      // import '@citolab/qti-components/qti-test/components/test-print-item-variables';
      // import '@citolab/qti-components/qti-test/components/test-print-context';
      // import '@citolab/qti-components/qti-test/components/test-scoring-buttons';
      // import '@citolab/qti-components/qti-test/components/test-view-toggle';
      import './src/lib/index';
    </script>

    <script defer>
      const map = new Map();
      map.set('kennisnet1', 'assets/api/kennisnet-1/');
      map.set('kennisnet2', 'assets/api/kennisnet-2/');
    </script>

    <script type="module" defer>
      const testContainer = document.querySelector('test-container');
      const testNavigation = document.querySelector('test-navigation');

      const router = new Navigo(null, true, '#');
      router.on({
        '/': () => {
          console.log('Home');
        },
        '/kennisnet1': () => {
          changeTest(map.get('kennisnet1'));
        },
        '/kennisnet2': () => {
          changeTest(map.get('kennisnet2'));
        }
      });
      router.resolve();

      async function changeTest(test) {
        const testNavigation = document.querySelector('test-navigation');
        testNavigation.configContext = {
          infoItemCategory: 'info'
        };
        testContainer.setAttribute('test-url', test + '/AssessmentTest.xml');
        // Fetch items.json with error handling
        try {
          const response = await fetch(test + 'items.json');
          testNavigation.initContext = response.ok ? await response.json() : null;
        } catch {
          console.error('Failed to fetch items.json');
        }
      }
    </script>

    <script type="module" defer>
      const stimulusRefContainer = document.getElementById('stimulusRefContainer');

      customElements.whenDefined('qti-test').then(() => {
        const qtiTest = document.querySelector('qti-test');

        const implemented = false;
        if (implemented) {
          // also declaratively in the html
          // qtiTest.navItemId = ""; <-- hier weghalen
          qtiTest.autoStoreRestore = 'KEY'; // exists
          qtiTest.cacheItems = false; // should be implemented
          qtiTest.autoScoreItems = true; // is now on : testNavigation.autoScoreItems
          qtiTest.reportValidityAfterScoring = true;

          qtiTest.autoLoad = 'item' | 'section'; // should be implemented
          // qtiTest.navigate = 'section' || 'item' // default is 'item' <-- zit nog n de peiling, automatisch eerste section laden

          // qtiTest.configContext = {
          // reportValidityAfterScoring: true,
          // infoItemCategory: 'info',
          // };

          // all items are loaded and the complete dom is rendered
          qtiTest.addEventListener('qti-test-loaded', e => {
            clickRules();
            markLines();
          });

          qtiTest.addEventListener('qti-load-item-request', e => {
            e.detail.promise = (async () => {
              const api = await qtiTransformItem().load(e.detail.href, true);
              return api.htmlDoc();
            })();
          });

          // the item is loaded and the dom is rendered
          qtiTest.addEventListener('qti-assessment-item-connected', e => {
            hideTitleOnMouseOver();
          });

          // the item has a stimulus ref and this is your chance to let the player place the stimulusref
          qtiTest.addEventListener('qti-assessment-stimulus-ref-connected', e => {
            e.preventDefault(); // this prevents the default behaviour of the item to set the stimulus content
            const assessmentStimulusRef = e.composedPath()[0];
            assessmentStimulusRef.updateStimulusRef(stimulusRefContainer);
          });

          // there is a request for navigation but it is not yet processed and handled ( ie it is not in the dom yet )
          qtiTest.addEventListener('qti-request-navigation', e => {
            history.pushState({}, '', `#${e.detail.id}`); // update URL of router
            stimulusRefContainer.innerHTML = '';
          });

          // ** not implemented yet **
          // the test context is updated because test-base got a "qti-item-context-updated" event
          qtiTest.addEventListener('qti-test-context-updated', e => {
            // from QtiAssessmentItem after processResponse
            const testContext = e.detail.testContext;
          });

          // ********* SPECIFIC TO THE LOADED QTI-ASSESSMENT-TEST *********
          // is now qti-assessment-test-connected
          qtiTest.addEventListener('qti-test-context-set', e => {
            if (testContext) {
              // in session
              qtiTest.detail.testContext = testContext;
            }

            // SPECIFIC TO WHICH ASSESSMENT XML
            (e.detail.infoItemCategory = 'info'),
              (e.detail.initContext = [
                { itemRefId: 'ITM001', pValue: 0.672, domain: 'Biologie' },
                { itemRefId: 'ITM002', pValue: 0.672, domain: 'Biologie' },
                { itemRefId: 'ITM003', pValue: 0.672, domain: 'Biologie' }
              ]);
          });

          qtiTest.load('./kennisnet-1/AssessmentTest.xml').then(() => {
            qtiTest.navigateTo('ITEM', ITM002);
            // qtiTest.navigateTo('SECTION', SECTION002) // can also navigate to a section
          });
        }
      });
    </script>

    <link
      href="https://cdn.jsdelivr.net/combine/npm/daisyui@5/base/properties.css,npm/daisyui@5/base/reset.css,npm/daisyui@5/base/rootcolor.css,npm/daisyui@5/base/rootscrollgutter.css,npm/daisyui@5/base/rootscrolllock.css,npm/daisyui@5/base/scrollbar.css,npm/daisyui@5/base/svg.css,npm/daisyui@5/components/button.css,npm/daisyui@5/components/checkbox.css,npm/daisyui@5/components/input.css,npm/daisyui@5/components/menu.css,npm/daisyui@5/components/select.css,npm/daisyui@5/components/toggle.css,npm/daisyui@5/theme/light.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <style type="text/tailwindcss">
      nav {
        anchor-name: --profile-button;
      }

      #popover-thumbs,
      #popover-list {
        position-anchor: --profile-button;
        bottom: anchor(top);
        left: anchor(left);

        &:popover-open {
          display: grid;
          opacity: 1;

          @starting-style {
            display: grid;
            opacity: 0;
          }
        }
      }
    </style>

    <style>
      test-container {
        --qti-bg-active: #efecff;
        --qti-border-active: #581d70;
        --qti-button-padding-vertical: 0.2rem;
        --bs-box-shadow: box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>

  <body class="bg-slate-50 h-screen w-screen">
    <!-- auto-store-restore="my session storage" cache-transform -->
    <qti-test class="h-full">
      <test-navigation class="h-full flex flex-col gap-2 pt-8 px-8" auto-score-items>
        <!-- <div class="flex flex-col flex-1"> -->
        <div class="flex items-center gap-2 justify-between">
          <test-stamp class="flex gap-2 items-center">
            <template>
              <test-view-toggle class-for-input="toggle"></test-view-toggle>
              <test-stamp class="flex gap-2 items-center">
                <template>
                  <template type="if" if="{{ item.view === 'scorer' }}">
                    <div class="flex gap-2">
                      <test-scoring-buttons view="scorer"></test-scoring-buttons>
                    </div>

                    <!-- <test-view>View</test-view> -->

                    <test-end-attempt class="btn btn-primary"> Feedback </test-end-attempt>
                    <test-show-correct-response class="btn btn-primary">
                      Toon correct antwoord
                    </test-show-correct-response>
                  </template>
                </template>
              </test-stamp>
            </template>
          </test-stamp>
        </div>

        <div
          popover
          id="popover-thumbs"
          class="opacity-0 inset-auto hidden absolute m-0 transition-opacity duration-1000 transform -translate-y-2 p-8 shadow-lg rounded-lg"
        >
          <div class="flex flex-wrap gap-2">
            <test-paging-buttons-stamp>
              <template>
                <test-item-link
                  class="cursor-pointer relative bg-white p-2 border-2 border-b-4 
                  {{ item.view === 'scorer' && item.correct ? 'border-green-400' : item.view === 'scorer' && item.incorrect && item.completed ? 'border-red-400' : item.completed ? 'border-slate-400' : '' }} 
                  {{ item.active ? '!border-sky-600' : '' }} 
                  {{ item.category === 'info' ? '' : 'rounded-2xl' }}"
                  item-id="{{ item.identifier }}"
                >
                  <img src="{{ item.thumbnail }}" alt="{{ item.title }}" />
                </test-item-link>
              </template>
            </test-paging-buttons-stamp>
          </div>
        </div>

        <div
          popover
          id="popover-list"
          class="opacity-0 inset-auto hidden absolute m-0 transition-opacity duration-1000 transform -translate-y-2 p-8 shadow-lg rounded-lg"
        >
          <div class="columns-1 md:columns-4">
            <test-paging-buttons-stamp>
              <template>
                <test-item-link
                  class="gap-2 px-2 text-sm py-1 flex items-center justify-between cursor-pointer {{ item.active ? 'bg-sky-500 text-white' : 'bg-transparent text-slate-600 ' }}"
                  item-id="{{ item.identifier }}"
                >
                  <div
                    class="flex items-center justify-center w-4 h-4 border-2 cursor-pointer {{ item.view === 'scorer' && item.correct ? 'bg-green-100 border-green-400' : item.view === 'scorer' && item.incorrect && item.completed ? 'bg-red-100 border-red-400' : item.completed ? 'bg-slate-300' : 'bg-white' }} p-0 {{ item.category === 'dep-informational' ? '' : 'rounded-full' }}"
                  ></div>
                  <div class="flex flex-grow gap-1 py-0.5">
                    {{ item.category === 'dep-informational' ? 'info' : item.title }}
                  </div>
                  <div class="w-4 text-right mr-2 text-xs text-slate-300">{{ item.index }}</div>
                </test-item-link>
              </template>
            </test-paging-buttons-stamp>
          </div>
        </div>

        <dialog
          popover
          id="popover-deliver"
          class="opacity-0 inset-auto hidden absolute m-0 transition-opacity duration-1000 transform -translate-y-2 p-8 shadow-lg rounded-lg"
        >
          <div class="columns-1 md:columns-4">
            <test-paging-buttons-stamp>
              <template>
                <test-item-link
                  class="gap-2 px-2 text-sm py-1 flex items-center justify-between cursor-pointer {{ item.active ? 'bg-sky-500 text-white' : 'bg-transparent text-slate-600 ' }}"
                  item-id="{{ item.identifier }}"
                >
                  <div
                    class="flex items-center justify-center w-4 h-4 border-2 cursor-pointer {{ item.view === 'scorer' && item.correct ? 'bg-green-100 border-green-400' : item.view === 'scorer' && item.incorrect && item.completed ? 'bg-red-100 border-red-400' : item.completed ? 'bg-slate-300' : 'bg-white' }} p-0 {{ item.category === 'dep-informational' ? '' : 'rounded-full' }}"
                  ></div>
                  <div class="flex flex-grow gap-1 py-0.5">
                    {{ item.category === 'dep-informational' ? 'info' : item.title }}
                  </div>
                  <div class="w-4 text-right mr-2 text-xs text-slate-300">{{ item.index }}</div>
                </test-item-link>
              </template>
            </test-paging-buttons-stamp>
          </div>
        </dialog>

        <div class="flex flex-1">
          <div id="stimulusRefContainer"></div>
          <test-container class="flex-grow block rounded bg-white p-16 overflow-auto shadow-sm prose"> </test-container>
        </div>

        <test-stamp class="flex justify-between items-center fixed bottom-8">
          <template>
            <button popovertarget="popover-deliver" class="btn btn-outline">
              Inleveren
              <i class="bi bi-grid"></i>
            </button>

            <nav class="flex shadow-2xl bg-white rounded-2xl border border-gray-200">
              <button
                popovertarget="sidePane"
                popovertargetaction="toggle"
                class="m-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                <i class="bi bi-gear"></i>
              </button>

              <div class="flex items-center">
                <div class="hidden flex-1 gap-1 overflow-auto md:flex">
                  <test-paging-buttons-stamp class="flex gap-2 p-2 overflow-auto">
                    <template>
                      <test-item-link
                        class="flex items-center justify-center aspect-square w-8 border-2 cursor-pointer p-0 {{ item.view === 'scorer' && item.correct ? 'bg-green-100 border-green-400' : item.view === 'scorer' && item.incorrect && item.completed ? 'bg-red-100 border-red-400' : item.completed ? 'bg-slate-300' : 'bg-transparent' }} {{ item.active ? '!border-sky-600' : ''}} {{ item.category === 'info' ? '' : 'rounded-full' }}"
                        item-id="{{ item.identifier }}"
                      >
                        {{ item.index}}
                        <template type="if" if="{{ item.category === 'info' }}">
                          <div class="w-1 h-1 rounded-full bg-slate-300"></div>
                        </template>
                      </test-item-link>
                    </template>
                  </test-paging-buttons-stamp>
                </div>

                <div class="flex gap-2">
                  <button popovertarget="popover-thumbs" class="btn btn-outline">
                    <i class="bi bi-grid"></i>
                  </button>
                  <button popovertarget="popover-list" class="btn btn-outline">
                    <i class="bi bi-list"></i>
                  </button>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <test-prev class="btn btn-primary" role="button">
                  <i class="bi bi-arrow-left-short"></i>
                </test-prev>
                <test-next class="btn btn-primary" role="button">
                  <div class="hidden md:flex">Volgende</div>
                  <i class="bi bi-arrow-right-short"></i>
                </test-next>
              </div>
            </nav>
          </template>
        </test-stamp>

        <div id="sidePane" popover class="relative! left-0 top-0 h-full w-1/2 bg-white shadow-lg p-4 shadow-lg z-50">
          <h2 class="text-xl mb-4">Side Panel</h2>
          <test-print-item-variables class="text-sm"></test-print-item-variables>
          <test-print-context></test-print-context>
          <button
            popovertarget="sidePane"
            popovertargetaction="hide"
            class="mt-4 px-3 py-1 bg-red-600 text-white rounded"
          >
            Close
          </button>
        </div>
      </test-navigation>
    </qti-test>
  </body>
</html>
